<?php

use TalkSlipSender\Utils\PDFAssignmentFormWriter;
use TalkSlipSender\Utils\PdfScheduleWriter;
use TalkSlipSender\Utils\MailSender;
use TalkSlipSender\Models\ListOfContacts;

use PHPMailer\PHPMailer\PHPMailer;
use Dotenv\Dotenv;

use function TalkSlipSender\Functions\workbookParserImplementation;
use function TalkSlipSender\Functions\createJsonSchedulesFromWorkbooks;
use function TalkSlipSender\Functions\sendEmails;
use function TalkSlipSender\Functions\decryptedPassword;
use function TalkSlipSender\Functions\scheduleRecipientError;
use function TalkSlipSender\Functions\contactSetupError;
use function TalkSlipSender\Functions\importAssignments;
use function TalkSlipSender\Functions\CLI\writeAssignmentForms;
use function TalkSlipSender\Functions\CLI\createJsonAssignments;
use function TalkSlipSender\Functions\CLI\yes;
use function TalkSlipSender\Functions\CLI\no;
use function TalkSlipSender\Functions\CLI\red;
use function TalkSlipSender\Functions\CLI\green;
use function TalkSlipSender\Functions\CLI\prompt;
use function TalkSlipSender\Functions\CLI\jsonScheduleCreationNotification;

require "autoload.php";

// load configuration files
$config_path = "config/";
$config_file = "${config_path}config.php";
$config = require $config_file;
$path_config = require "${config_path}path_config.php";
$schedule_recipients_config_file = "${config_path}schedule_recipients.php";
$contacts_file = "${config_path}contacts.php";


// creates an empty contacts file if one has not been created yet
!file_exists($contacts_file) && file_put_contents($contacts_file, "<?php" . PHP_EOL . "return [];" . PHP_EOL);

// the contacts file and schedule recipients must be setup first
empty($contacts = require $contacts_file)
    && exit(red(contactSetupError($contacts_file)));
empty($schedule_recipients = require $schedule_recipients_config_file)
    && exit(red(scheduleRecipientError($schedule_recipients_config_file)));

$Dotenv = new Dotenv(__DIR__);
$Dotenv->load();
$Dotenv->required([
    "from_email",
    "from_email_password",
    "from_email_nonce",
    "from_email_key",
    "smtp_host"
]);

$WorkbookParser = workbookParserImplementation($config);
$AssignmentFormWriter = new PDFAssignmentFormWriter($config);
$ScheduleWriter = new PdfScheduleWriter($config);
$ListOfContacts = new ListOfContacts();
$MailSender = new MailSender(
    new PHPMailer(true),
    getenv("from_email"),
    decryptedPassword(),
    getenv("smtp_host")
);

/**
 * Parse pdf schedules into json
 *
 * Data derived from the json schedules are used
 * when the user of the application schedules assignments
 * and for writing out assignment forms
 */

$path_to_workbooks = $path_config["path_to_workbooks"]
    . DIRECTORY_SEPARATOR
    . $config["workbook_format"];

$scheduleCreationNotificationFunc = jsonScheduleCreationNotification();

$SetOfYearsSchedulesWhereIn = createJsonSchedulesFromWorkbooks(
    $WorkbookParser,
    $path_to_workbooks,
    $path_config["path_to_data"],
    $scheduleCreationNotificationFunc
);


$hasScheduleAlreadyBeenCompleted = function (string $month) use ($path_config) {
    $schedule_filename = "{$path_config["path_to_schedules"]}/${month}.pdf";

    return file_exists($schedule_filename);
};


/**
 * These strings will be modified by an anonymous function
 */
$path_to_json_schedules = "{$path_config["path_to_data"]}/";
$path_to_json_assignments = "{$path_config["path_to_assignments"]}/";

$createJsonAssignments = function (
    $carry,
    int $year
) use (
    $AssignmentFormWriter,
    &$path_to_json_schedules,
    &$path_to_json_assignments,
    $hasScheduleAlreadyBeenCompleted
) {

    $path_to_json_schedules .= $year;
    $path_to_json_assignments .= $year;
    /**
     * Interact with the user of the application to schedule assignments
     *
     * A json file is created for each week of assignments
     */
    createJsonAssignments(
        $path_to_json_schedules,
        $path_to_json_assignments,
        $hasScheduleAlreadyBeenCompleted
    );
};


/**
 * An instance of \Ds\Set so the values will be unique
 * @var \Ds\Set $SetOfYearsSchedulesWhereIn
 */
$SetOfYearsSchedulesWhereIn->remove(null);
$SetOfYearsSchedulesWhereIn->reduce($createJsonAssignments);



/**
 * Create assignment forms
 *
 * The json files representing weeks of assignments are used
 * to generate pdf assignment forms
 */
$which_months = writeAssignmentForms(
    $AssignmentFormWriter,
    $path_to_json_assignments,
    $path_to_json_schedules,
    $hasScheduleAlreadyBeenCompleted,
    false
);

/**
 * Were assignments scheduled?
 */
current($which_months)
    || exit(green("It looks like you are all up-to-date.\r\nNo schedules were created.  Good Bye\r\n"));


/**
 * Create the schedule for the month
 *
 * Uses the json schedule and the json assignment files
 * to generate a pdf schedule for the month
 */
$month = current($which_months);
$assignments = importAssignments($month, $path_to_json_assignments);
$schedule = weeksFrom(importJson("{$path_config["path_to_schedules"]}/${month}"));

$schedule_filename = $ScheduleWriter->create($assignments, $schedule, $month);


$user_response = readline(
    prompt("Do you want to send the emails")
);


yes($user_response)
    && sendEmails(
        $MailSender,
        $ListOfContacts,
        $contacts,
        $config["assignment_forms_destination"],
        $schedule_recipients,
        $schedule_filename
    );

no($user_response)
    && print red("Ok. Emails were not sent.\r\n");

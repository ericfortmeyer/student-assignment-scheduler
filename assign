<?php

use TalkSlipSender\PDFAssignmentFormWriter;
use TalkSlipSender\ScheduleWriter;
use TalkSlipSender\MailSender;
use TalkSlipSender\ListOfContacts;

use PHPMailer\PHPMailer\PHPMailer;
use Dotenv\Dotenv;
use Smalot\PdfParser\Parser;

use function TalkSlipSender\Functions\createJsonSchedulesFromWorkbooks;
use function TalkSlipSender\Functions\sendEmails;
use function TalkSlipSender\Functions\scheduleRecipientError;
use function TalkSlipSender\Functions\contactSetupError;
use function TalkSlipSender\Functions\makeDirectories;
use function TalkSlipSender\Functions\writeSchedule;
use function TalkSlipSender\Functions\CLI\writeAssignmentForms;
use function TalkSlipSender\Functions\CLI\createJsonAssignments;
use function TalkSlipSender\Functions\CLI\yes;
use function TalkSlipSender\Functions\CLI\no;
use function TalkSlipSender\Functions\CLI\red;
use function TalkSlipSender\Functions\CLI\green;
use function TalkSlipSender\Functions\CLI\prompt;

require "autoload.php";

$config_path = "config/";
$config = require "${config_path}config.php";
$path_config = require "${config_path}path_config.php";
$schedule_recipients_config_file = "${config_path}schedule_recipients.php";
$contacts_file = "${config_path}contacts.php";

!file_exists($contacts_file) && file_put_contents($contacts_file, "<?php" . PHP_EOL . "return [];" . PHP_EOL);
$schedule_recipients = require $schedule_recipients_config_file;
$contacts = require $contacts_file;

empty($contacts) && exit(red(contactSetupError($contacts_file)));
empty($schedule_recipients) && exit(red(scheduleRecipientError($schedule_recipients_config_file)));

$Dotenv = new Dotenv(__DIR__);
$Dotenv->load();
$WorkbookParser = new Parser();
$AssignmentFormWriter = new PDFAssignmentFormWriter($config);
$ScheduleWriter = new ScheduleWriter($config);
$ListOfContacts = new ListOfContacts();
$MailSender = new MailSender(
    new PHPMailer(true),
    $config["from_email"],
    getenv("from_email_password")
);

makeDirectories(
    [
        $path_to_assignment_forms = $path_config["path_to_forms"],
        $path_to_json_assignments_files = "{$path_config["path_to_data"]}/assignments/2018",
        $path_to_assignment_forms,
        $path_config["path_to_schedules"],
        $path_to_json_assignments_files,
        "{$path_config["path_to_data"]}/2018",
        "{$path_config["path_to_data"]}/2019"
    ]
);


createJsonSchedulesFromWorkbooks(
    $WorkbookParser,
    $path_config["path_to_workbooks"],
    $path_config["path_to_data"]
);
print green("Schedules were created from workbooks\r\n");



createJsonAssignments(
    "{$path_config["path_to_data"]}/2018",
    "{$path_config["path_to_data"]}/assignments"
);

$options = getopt(
    "p::",
    ["past::"]
);

extract($options);

writeAssignmentForms(
    $AssignmentFormWriter,
    $path_to_json_assignments_files,
    "{$path_config["path_to_data"]}/2018",
    ($past ?? $p ?? false)
);

writeAssignmentForms(
    $AssignmentFormWriter,
    $path_to_json_assignments_files,
    "{$path_config["path_to_data"]}/2018"
);

$schedule_filename = writeSchedule(
    $ScheduleWriter,
    $path_to_json_assignments_files,
    "{$path_config["path_to_data"]}/2018",
    "November"
);


$user_response = readline(
    prompt("Do you want to send the emails")
);




yes($user_response)
    && sendEmails(
        $MailSender,
        $ListOfContacts,
        $contacts,
        $config["assignment_forms_destination"],
        $schedule_recipients,
        $schedule_filename
    );

no($user_response)
    && print red("Ok. Emails were not sent.\r\n");
